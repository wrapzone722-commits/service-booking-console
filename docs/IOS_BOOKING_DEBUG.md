# iOS: кнопка «Записаться» ничего не делает — отладка

Если при нажатии «Записаться» в iOS-приложении ничего не происходит, проверьте по шагам ниже.

---

## 1. Куда должен уходить запрос

**Создание записи:**

- **URL:** `POST {base_url}/bookings`
- **Base URL** — тот, что сохранён при подключении к мастерской (QR или ручной ввод), например: `https://your-server.com/api/v1`
- **Итого:** `POST https://your-server.com/api/v1/bookings`

Сервер также принимает алиас (если в приложении используется префикс `/api/client`):

- `POST {host}/api/client/appointments` (без суффикса `:id`).

---

## 2. Заголовки (обязательно)

- **Content-Type:** `application/json`  
  Без него сервер не разберёт тело запроса, `req.body` будет пустой и вернётся ошибка «Missing required fields».
- **Авторизация** (один из вариантов):
  - **X-API-Key:** `{api_key}` (значение из ответа `POST .../clients/register`)
  - или **Authorization:** `Bearer {api_key}`

Если не передать валидный `api_key`, запись может создаться «гостем» или вернётся 401.

---

## 3. Тело запроса (JSON)

Минимум:

```json
{
  "service_id": "svc_123...",
  "date_time": "2026-02-15T10:00:00.000Z"
}
```

Либо вместо `date_time` можно передать **start_iso** (то же значение в ISO 8601):

```json
{
  "service_id": "svc_123...",
  "start_iso": "2026-02-15T10:00:00.000Z"
}
```

Опционально: `post_id` (по умолчанию `post_1`), `notes`.

- `service_id` — id выбранной услуги из `GET .../services`.
- `date_time` / `start_iso` — дата и время слота в формате ISO 8601 (как в ответе `GET .../slots`).

---

## 4. Проверка с сервера (curl)

Подставьте свой `BASE_URL` и `API_KEY` и выполните:

```bash
curl -X POST "$BASE_URL/bookings" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: $API_KEY" \
  -d '{"service_id":"<id_услуги>","date_time":"2026-02-15T10:00:00.000Z"}'
```

Успех: ответ 201 и JSON с полем `_id` и данными записи.  
Ошибка: 4xx/5xx и JSON с полями `error` и `message`.

---

## 5. Что проверить в iOS-приложении

1. **Кнопка «Записаться» реально вызывает запрос**
   - Поставьте breakpoint или логирование в обработчик нажатия и в метод, который выполняет `POST .../bookings` (или `.../api/client/appointments`).
   - Убедитесь, что до отправки запроса доходит (например, лог «Sending booking request»).

2. **Base URL**
   - Должен заканчиваться на `/api/v1` (например, `https://your-server.com/api/v1`).
   - Запрос создания записи: `URL(base + "/bookings")` или эквивалент, без лишних слэшей и без дублирования пути.

3. **Заголовки**
   - Обязательно: `Content-Type: application/json`.
   - Обязательно: `X-API-Key: <api_key>` или `Authorization: Bearer <api_key>`.

4. **Тело**
   - Сериализованный JSON с полями `service_id` и `date_time` (или `start_iso`).
   - Дата/время — строка в ISO 8601, как приходит в слотах.

5. **Обработка ответа**
   - При 4xx/5xx показывайте пользователю текст из `message` (или `error`) в alert/toast, а не «ничего не происходит».
   - При успехе (201) обновите экран (например, переход на «Мои записи» или показ подтверждения).

6. **Сеть**
   - В логах Xcode смотрите, уходит ли запрос и какой приходит ответ (код и тело).
   - При проблемах с сертификатом/HTTPS запрос может «молча» падать — проверьте ATS и при необходимости временно логировать ошибки URLSession.

---

## 6. Логи на сервере (консоль)

При включённом логе на бэкенде при каждом `POST .../bookings` пишется, например:

- `[bookings] POST create` — есть ли тело, какие ключи, есть ли авторизация.
- При ошибке валидации: `[bookings] Validation failed: ...`
- При неверном/просроченном токене: `[bookings] Create failed: invalid or expired token ...`
- При успехе: `[bookings] Created <id> <service_name> <user_name>`

По этим сообщениям можно понять: пришёл ли запрос, хватает ли полей, прошла ли авторизация.

---

## Итог

Чаще всего «ничего не происходит» из‑за одного из:

- Запрос вообще не отправляется (кнопка не привязана к вызову API или не тот URL).
- Не передаётся `Content-Type: application/json` → тело пустое → «Missing required fields».
- Не передаётся или неверный `api_key` → 401 без отображения ошибки в приложении.
- В приложении не показывается ошибка от API (пользователь не видит причину).

Рекомендуется: в iOS при любом ответе с кодом ≥ 400 показывать пользователю `message` из тела ответа.
