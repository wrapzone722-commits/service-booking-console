# iOS: кнопка «Подтвердить запись» / «Записаться» не срабатывает — отладка

Если на экране **«Запись на услугу»** при нажатии кнопки **«Подтвердить запись»** ничего не происходит, проверьте по шагам ниже. Исправления вносятся в **код iOS-приложения** (экран выбора времени и кнопка отправки).

---

## 1. Куда должен уходить запрос

**Создание записи:**

- **URL:** `POST {base_url}/bookings`
- **Base URL** — тот, что сохранён при подключении к мастерской (QR или ручной ввод), например: `https://your-server.com/api/v1`
- **Итого:** `POST https://your-server.com/api/v1/bookings`

Сервер также принимает алиас (если в приложении используется префикс `/api/client`):

- `POST {host}/api/client/appointments` (без суффикса `:id`).

---

## 2. Заголовки (обязательно)

- **Content-Type:** `application/json`  
  Без него сервер не разберёт тело запроса, `req.body` будет пустой и вернётся ошибка «Missing required fields».
- **Авторизация** (один из вариантов):
  - **X-API-Key:** `{api_key}` (значение из ответа `POST .../clients/register`)
  - или **Authorization:** `Bearer {api_key}`

Если не передать валидный `api_key`, запись может создаться «гостем» или вернётся 401.

---

## 3. Тело запроса (JSON)

Сервер принимает **snake_case** и **camelCase**, а также разные имена для даты/времени.

**Вариант 1 (snake_case):**

```json
{
  "service_id": "svc_123...",
  "date_time": "2026-02-15T10:00:00.000Z"
}
```

**Вариант 2 (camelCase для iOS):**

```json
{
  "serviceId": "svc_123...",
  "dateTime": "2026-02-15T10:00:00.000Z"
}
```

**Вариант 3 (поле slot / time / start_iso):**

```json
{
  "service_id": "svc_123...",
  "slot": "2026-02-15T10:00:00.000Z"
}
```

Поддерживаемые поля времени: `date_time`, `start_iso`, `startIso`, `slot`, `time`, `dateTime`.  
Поддерживаемые поля услуги: `service_id`, `serviceId`.  
Опционально: `post_id` / `postId` (по умолчанию `post_1`), `notes`.

---

## 4. Проверка доступности API с iOS

В приложении можно проверить, доходит ли запрос до сервера:

- **GET** `{base_url}/bookings/check`  
  Ответ: `{ "ok": true, "message": "Booking API reachable from iOS" }`.  
  Если этот запрос с тем же base_url и заголовками проходит — сеть и URL настроены верно.

## 5. Проверка с сервера (curl)

Подставьте свой `BASE_URL` и `API_KEY` и выполните:

```bash
curl -X POST "$BASE_URL/bookings" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: $API_KEY" \
  -d '{"service_id":"<id_услуги>","date_time":"2026-02-15T10:00:00.000Z"}'
```

Успех: ответ 201 и JSON с полем `_id` и данными записи.  
Ошибка: 4xx/5xx и JSON с полями `error` и `message`.

---

## 6. Экран «Запись на услугу» — что должно происходить по нажатию «Подтвердить запись»

1. **Обработчик кнопки** должен вызывать метод создания записи (например `createBooking()` или `submitBooking()`), а не только закрывать экран или показывать алерт без запроса.
2. **Сформировать тело запроса** из выбранных данных:
   - ID услуги (из экрана выбора услуги),
   - дата и время слота в ISO 8601, например `"2026-02-17T19:30:00.000Z"` (для 17 февраля 2026, 19:30).
3. **Отправить запрос:** `POST {baseURL}/bookings` с заголовками `Content-Type: application/json` и `X-API-Key: {api_key}` (или `Authorization: Bearer {api_key}`), тело — JSON с `service_id` и `date_time` (или `serviceId` и `dateTime`, или `slot`).
4. **Обработать ответ:** при коде 201 — перейти на экран подтверждения/«Мои записи»; при 4xx/5xx — показать пользователю текст из поля `message` в ответе (alert или toast), иначе создаётся впечатление, что «кнопка не срабатывает».

Без шага 4 пользователь не видит ни успех, ни ошибку (например «Service not found» или «Missing required fields»).

---

## 7. Что проверить в iOS-приложении

1. **Кнопка «Подтвердить запись» реально вызывает запрос**
   - Поставьте breakpoint или логирование в обработчик нажатия и в метод, который выполняет `POST .../bookings` (или `.../api/client/appointments`).
   - Убедитесь, что до отправки запроса доходит (например, лог «Sending booking request»).

2. **Base URL**
   - Должен заканчиваться на `/api/v1` (например, `https://your-server.com/api/v1`).
   - Запрос создания записи: `URL(base + "/bookings")` или эквивалент, без лишних слэшей и без дублирования пути.

3. **Заголовки**
   - Обязательно: `Content-Type: application/json`.
   - Обязательно: `X-API-Key: <api_key>` или `Authorization: Bearer <api_key>`.

4. **Тело**
   - Сериализованный JSON с полями `service_id` и `date_time` (или `start_iso`).
   - Дата/время — строка в ISO 8601, как приходит в слотах.

5. **Обработка ответа**
   - При 4xx/5xx показывайте пользователю текст из `message` (или `error`) в alert/toast, а не «ничего не происходит».
   - При успехе (201) обновите экран (например, переход на «Мои записи» или показ подтверждения).

6. **Сеть**
   - В логах Xcode смотрите, уходит ли запрос и какой приходит ответ (код и тело).
   - При проблемах с сертификатом/HTTPS запрос может «молча» падать — проверьте ATS и при необходимости временно логировать ошибки URLSession.

---

## 8. Логи на сервере (консоль)

При каждом запросе создания записи на бэкенде пишется:

- `[bookings] POST create request` — url, path, Content-Type, список ключей тела (или "no-body"). Если этой строки нет — запрос до сервера не доходит (проверьте URL и сеть в iOS).
- `[bookings] POST create parsed` — после разбора тела: service_id, date_time, есть ли авторизация.
- При пустом теле: `[bookings] Create failed: empty or invalid body`
- При нехватке полей: `[bookings] Create failed: missing service_id or date_time. Received keys: ...`
- При успехе: `[bookings] Created <id> <service_name> <user_name>`

По ним можно понять: доходит ли запрос, правильно ли разбирается тело, прошла ли авторизация.

---

## Итог

Чаще всего «ничего не происходит» из‑за одного из:

- Запрос вообще не отправляется (кнопка не привязана к вызову API или не тот URL).
- Не передаётся `Content-Type: application/json` → тело пустое → «Missing required fields».
- Не передаётся или неверный `api_key` → 401 без отображения ошибки в приложении.
- В приложении не показывается ошибка от API (пользователь не видит причину).

Рекомендуется: в iOS при любом ответе с кодом ≥ 400 показывать пользователю `message` из тела ответа.
