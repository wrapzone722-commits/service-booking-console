# Акт выполненных работ

## Назначение

Документ «Акт выполненных работ» формируется для **завершённых** записей (статус `completed`) и содержит сведения об исполнителе, заказчике, перечне оказанных услуг и сумме к оплате.

---

## Где доступен акт

### Консоль (веб)

- Раздел **Записи** → у каждой записи со статусом **«Завершена»** отображается кнопка **«Акт»**.
- По нажатию открывается PDF в новой вкладке. Документ можно сохранить или отправить через браузер (печать в PDF, «Сохранить как» и т.п.).

### iOS приложение

- **Мои записи** → вкладка **«Прошедшие»** → напротив каждой прошедшей (завершённой) записи — кнопка **«Акт»**.
- По нажатию открывается сформированный акт (PDF). Пользователь может сохранить файл или отправить его через системное меню iOS (Поделиться / Сохранить в «Файлы» и т.д.).

Рекомендуемая реализация в iOS:

1. Запрос: `GET {base_url}/bookings/{booking_id}/act` с заголовком `Authorization: Bearer {api_key}` (ключ из регистрации клиента).
2. Ответ: бинарный PDF (`Content-Type: application/pdf`).
3. Отобразить PDF в `WKWebView` / `PDFKit` / `QLPreviewController` и дать пользователю действия «Сохранить» / «Поделиться» через системный share sheet.

---

## API

| Метод | URL | Авторизация | Описание |
|--------|-----|-------------|----------|
| GET | `/api/v1/bookings/:id/act` | Bearer JWT (админ) или Bearer api_key (клиент) | Возвращает PDF-акт для завершённой записи. Клиент может запрашивать только свои записи. |

- Для записи не в статусе `completed` возвращается ошибка 400.
- Заголовок ответа: `Content-Disposition: inline; filename="akt-{id}.pdf"` — браузер/приложение могут открыть файл как «Акт».

---

## Шаблон акта (содержимое)

Шаблон заполняется данными из:

- **Организация (исполнитель):** из настроек аккаунта (Компания): название, адрес, ИНН, ОГРН, телефон, ФИО руководителя.
- **Клиент (заказчик):** из профиля пользователя записи: ФИО, телефон, e-mail.
- **Услуга:** из записи: наименование услуги, дата/время оказания, цена, длительность.

Структура документа:

1. **Заголовок** — «АКТ ВЫПОЛНЕННЫХ РАБОТ».
2. **Номер и дата акта** — номер в формате `ГГГГ-ММ-ДД-{shortId}`, дата — дата оказания услуги.
3. **Исполнитель** — наименование организации, адрес, ИНН/ОГРН, телефон.
4. **Заказчик** — ФИО клиента, телефон, e-mail.
5. **Преамбула** — текст о том, что исполнитель оказал услуги, заказчик их принял.
6. **Таблица работ:**
   - № п/п
   - Наименование работы (услуги)
   - Ед. изм. (усл.)
   - Количество (1)
   - Цена за ед., ₽
   - Сумма, ₽
7. **Итого** — сумма цифрой и прописью.
8. **Дата оказания услуги** — дата и время из записи.
9. **Подписи** — блоки «Исполнитель» и «Заказчик» с полями для подписи и расшифровки; примечание о том, что документ сформирован в электронном виде и подпись заказчика может быть проставлена при получении.

Данные организации для акта задаются в консоли в разделе **Компания** (профиль организации): название, адрес, ИНН, ОГРН, банковские реквизиты, ФИО руководителя. Оттуда же подставляются контакты (телефон и т.д.).

---

## Кириллица в PDF

Генерация PDF выполняется на сервере (библиотека PDFKit). Для корректного отображения кириллицы в папку `server/fonts/` нужно поместить TTF-шрифт с поддержкой русского языка (например, **PT Sans** — `PTSans-Regular.ttf`). Подробнее см. `server/fonts/README.md`.

---

## Хранение

Акты **не хранятся** в виде готовых файлов: PDF формируется по запросу из данных записи, организации и клиента. Для каждой завершённой записи акт можно получать многократно через API или кнопку «Акт» в консоли / в приложении.
